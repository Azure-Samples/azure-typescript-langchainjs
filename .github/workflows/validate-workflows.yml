name: Validate GitHub Actions Workflows

on:
  push:
    paths:
      - '.github/workflows/**'
  pull_request:
    paths:
      - '.github/workflows/**'
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 9:00 AM UTC to check for outdated actions
    - cron: '0 9 * * 1'

jobs:
  validate-workflows:
    name: Validate Workflow Files
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install actionlint
        run: |
          # Download actionlint v1.7.9 (pinned version)
          curl -sL https://github.com/rhysd/actionlint/releases/download/v1.7.9/actionlint_1.7.9_linux_amd64.tar.gz -o actionlint.tar.gz
          tar xzf actionlint.tar.gz
          sudo mv ./actionlint /usr/local/bin/
          rm actionlint.tar.gz
          actionlint --version
      
      - name: Run actionlint
        run: |
          echo "Running actionlint to validate workflow syntax and best practices..."
          actionlint -color
        continue-on-error: false
  
  detect-outdated-actions:
    name: Detect Outdated Actions
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Extract actions from workflows
        id: extract-actions
        run: |
          echo "Extracting actions from workflow files..."
          mkdir -p /tmp/workflow-analysis
          
          # Extract all 'uses:' lines from workflow files
          find .github/workflows -name "*.yml" -o -name "*.yaml" | while IFS= read -r workflow; do
            echo "Analyzing $workflow"
            grep -E "^\s*uses:" "$workflow" | sed 's/.*uses:\s*//' | sed 's/#.*//' | sed 's/\s*$//' >> /tmp/workflow-analysis/actions.txt || true
          done
          
          # Remove duplicates and sort
          if [ -f /tmp/workflow-analysis/actions.txt ]; then
            sort -u /tmp/workflow-analysis/actions.txt > /tmp/workflow-analysis/unique_actions.txt
            echo "Found actions:"
            cat /tmp/workflow-analysis/unique_actions.txt
            
            # Count actions
            ACTION_COUNT=$(wc -l < /tmp/workflow-analysis/unique_actions.txt)
            echo "Total unique actions: $ACTION_COUNT"
          else
            echo "No actions found in workflows"
          fi
      
      - name: Check action availability and versions
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking if actions are available on GitHub..."
          
          if [ ! -f /tmp/workflow-analysis/unique_actions.txt ]; then
            echo "No actions to check"
            exit 0
          fi
          
          UNAVAILABLE_ACTIONS=""
          
          while IFS= read -r action; do
            # Skip local actions (starting with ./)
            if [[ "$action" == ./* ]]; then
              echo "✓ Local action: $action (skipped)"
              continue
            fi
            
            # Extract owner/repo and version
            ACTION_PATH=$(echo "$action" | cut -d'@' -f1)
            ACTION_VERSION=$(echo "$action" | cut -d'@' -f2)
            
            # Check if action exists
            if [[ "$ACTION_PATH" == *"/"* ]]; then
              echo "Checking $ACTION_PATH@$ACTION_VERSION..."
              
              # Use GitHub API with authentication for better rate limits
              API_URL="https://api.github.com/repos/$ACTION_PATH"
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "$API_URL")
              
              if [ "$HTTP_CODE" -eq 200 ]; then
                echo "✓ Action available: $action"
                
                # Try to fetch latest release for comparison
                LATEST_RELEASE=$(curl -s \
                  -H "Authorization: token $GITHUB_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "$API_URL/releases/latest" | grep '"tag_name":' | sed -E 's/.*"tag_name": "([^"]+)".*/\1/' || echo "")
                
                if [ -n "$LATEST_RELEASE" ] && [ "$ACTION_VERSION" != "$LATEST_RELEASE" ]; then
                  echo "  ℹ️  Latest version available: $LATEST_RELEASE (current: $ACTION_VERSION)"
                fi
              else
                echo "✗ Action not found or inaccessible: $action (HTTP $HTTP_CODE)"
                UNAVAILABLE_ACTIONS="${UNAVAILABLE_ACTIONS}${action}\n"
              fi
            fi
          done < /tmp/workflow-analysis/unique_actions.txt
          
          if [ -n "$UNAVAILABLE_ACTIONS" ]; then
            echo ""
            echo "⚠️  Warning: Some actions are unavailable:"
            echo -e "$UNAVAILABLE_ACTIONS"
          fi
      
      - name: Generate action version report
        run: |
          {
            echo "## Action Version Report"
            echo ""
            echo "This report lists all GitHub Actions used in workflows:"
            echo ""
          } > /tmp/workflow-analysis/report.md
          
          if [ -f /tmp/workflow-analysis/unique_actions.txt ]; then
            {
              echo "| Action | Version | Status |"
              echo "|--------|---------|--------|"
            } >> /tmp/workflow-analysis/report.md
            
            while IFS= read -r action; do
              ACTION_PATH=$(echo "$action" | cut -d'@' -f1)
              ACTION_VERSION=$(echo "$action" | cut -d'@' -f2)
              echo "| \`$ACTION_PATH\` | \`$ACTION_VERSION\` | ✓ In use |" >> /tmp/workflow-analysis/report.md
            done < /tmp/workflow-analysis/unique_actions.txt
          else
            echo "No actions found in workflows." >> /tmp/workflow-analysis/report.md
          fi
          
          {
            echo ""
            echo "---"
            echo "Generated on: $(date -u)"
          } >> /tmp/workflow-analysis/report.md
          
          cat /tmp/workflow-analysis/report.md
      
      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workflow-validation-report
          path: /tmp/workflow-analysis/report.md
          retention-days: 30

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-workflows, detect-outdated-actions]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          {
            echo "# Workflow Validation Summary"
            echo ""
            echo "✅ All workflow validation jobs completed"
            echo ""
            echo "## Jobs Status:"
            echo "- Validate Workflows: ${{ needs.validate-workflows.result }}"
            echo "- Detect Outdated Actions: ${{ needs.detect-outdated-actions.result }}"
          } >> "$GITHUB_STEP_SUMMARY"
