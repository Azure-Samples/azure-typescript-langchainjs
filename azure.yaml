name: azure-typescript-langchainjs
metadata:
  template: azure-typescript-langchainjs

infra:
  bicep:
    path: ./infra/main.bicep
    parameters:
      principalId: ${AZURE_PRINCIPAL_ID}

hooks:
  prepackage:
    posix:
      sh: bash
      run: |
        # Validate environment name
        ENV_NAME=$(azd env get-values | grep AZURE_ENV_NAME | cut -d'=' -f2 | tr -d '"')
        
        if [[ ! "$ENV_NAME" =~ ^[a-z][a-z0-9-]*[a-z0-9]$ ]]; then
          echo "ERROR: Environment name '$ENV_NAME' is invalid."
          echo "Must start with a letter, end with letter/number, and contain only lowercase letters, numbers, and hyphens."
          exit 1
        fi
        
        if [[ ${#ENV_NAME} -lt 3 || ${#ENV_NAME} -gt 64 ]]; then
          echo "ERROR: Environment name must be between 3 and 64 characters."
          exit 1
        fi
        
        echo "Environment name '$ENV_NAME' is valid."
        
        # Validate that generated resource names will be valid
        # Simulate the resource token generation (first 13 chars of uniqueString)
        SUBSCRIPTION_ID=$(azd env get-values | grep AZURE_SUBSCRIPTION_ID | cut -d'=' -f2 | tr -d '"')
        LOCATION=$(azd env get-values | grep AZURE_LOCATION | cut -d'=' -f2 | tr -d '"')
        
        if [[ -z "$SUBSCRIPTION_ID" || -z "$LOCATION" ]]; then
          echo "WARNING: Cannot validate resource names (missing subscription or location)"
        else
          # Approximate resource token (13 chars) - actual will be generated by Bicep
          # For validation, we'll use a worst-case 13-char token
          RESOURCE_TOKEN="xxxxxxxxxxxxx"
          CONTAINER_APP_NAME="app-${RESOURCE_TOKEN}"
          
          # Validate Container App name rules:
          # - Must be 2-32 characters
          # - Lowercase alphanumeric or '-'
          # - Start with letter
          # - End with alphanumeric
          # - Cannot contain '--'
          
          if [[ ${#CONTAINER_APP_NAME} -gt 32 ]]; then
            echo "ERROR: Generated Container App name '${CONTAINER_APP_NAME}' is too long (${#CONTAINER_APP_NAME} chars, max 32)."
            exit 1
          fi
          
          if [[ ! "$CONTAINER_APP_NAME" =~ ^[a-z][a-z0-9-]*[a-z0-9]$ ]]; then
            echo "ERROR: Generated Container App name '${CONTAINER_APP_NAME}' is invalid."
            echo "Must start with a letter, end with alphanumeric, and contain only lowercase letters, numbers, and hyphens."
            exit 1
          fi
          
          if [[ "$CONTAINER_APP_NAME" =~ -- ]]; then
            echo "ERROR: Generated Container App name '${CONTAINER_APP_NAME}' contains '--' which is not allowed."
            exit 1
          fi
          
          echo "Container App name validation passed (estimated: ${CONTAINER_APP_NAME})"
        fi
    windows:
      shell: pwsh
      run: |
        $envName = (azd env get-values | Select-String "AZURE_ENV_NAME").ToString().Split('=')[1].Trim('"')
        
        if ($envName -notmatch '^[a-z][a-z0-9-]*[a-z0-9]$') {
          Write-Error "Environment name '$envName' is invalid. Must start with a letter, end with letter/number, and contain only lowercase letters, numbers, and hyphens."
          exit 1
        }
        
        if ($envName.Length -lt 3 -or $envName.Length -gt 64) {
          Write-Error "Environment name must be between 3 and 64 characters."
          exit 1
        }
        
        Write-Host "Environment name '$envName' is valid."
        
        # Validate that generated resource names will be valid
        $subscriptionId = (azd env get-values | Select-String "AZURE_SUBSCRIPTION_ID").ToString().Split('=')[1].Trim('"')
        $location = (azd env get-values | Select-String "AZURE_LOCATION").ToString().Split('=')[1].Trim('"')
        
        if ([string]::IsNullOrEmpty($subscriptionId) -or [string]::IsNullOrEmpty($location)) {
          Write-Warning "Cannot validate resource names (missing subscription or location)"
        } else {
          # Approximate resource token (13 chars) - actual will be generated by Bicep
          $resourceToken = "xxxxxxxxxxxxx"
          $containerAppName = "app-$resourceToken"
          
          # Validate Container App name rules
          if ($containerAppName.Length -gt 32) {
            Write-Error "Generated Container App name '$containerAppName' is too long ($($containerAppName.Length) chars, max 32)."
            exit 1
          }
          
          if ($containerAppName -notmatch '^[a-z][a-z0-9-]*[a-z0-9]$') {
            Write-Error "Generated Container App name '$containerAppName' is invalid. Must start with a letter, end with alphanumeric, and contain only lowercase letters, numbers, and hyphens."
            exit 1
          }
          
          if ($containerAppName -match '--') {
            Write-Error "Generated Container App name '$containerAppName' contains '--' which is not allowed."
            exit 1
          }
          
          Write-Host "Container App name validation passed (estimated: $containerAppName)"
        }
  
  postprovision:
    posix: 
      sh: bash
      run: |
        # Get environment values for the application
        azd env get-values > .env
        echo "Environment configured. Data will be loaded after deployment."
    windows:
      shell: pwsh
      run: |
        azd env get-values > .env
        Write-Host "Environment configured. Data will be loaded after deployment."
  # azd hooks run postdeploy
  postdeploy:
    posix:
      sh: bash
      run: |
        echo "Checking if vector store data needs to be loaded..."
        
        # Check if already loaded
        INDEX_CREATED=$(azd env get-values | grep INDEX_CREATED | cut -d'=' -f2 || echo "false")
        
        if [ "$INDEX_CREATED" = "true" ]; then
          echo "Index already created. Skipping data load."
          echo "Current document count: $(azd env get-values | grep INDEX_DOCUMENT_COUNT | cut -d'=' -f2)"
        else
          echo "Loading vector store data..."
          npm install
          npm run build
          npm run load_data
          
          # Get document count from the index
          SEARCH_SERVICE=$(azd env get-values | grep AZURE_AISEARCH_ENDPOINT | cut -d'/' -f3 | cut -d'.' -f1)
          DOC_COUNT=$(az search index show --service-name $SEARCH_SERVICE --name northwind --query "documentCount" -o tsv 2>/dev/null || echo "0")
          
          # Mark as loaded
          azd env set INDEX_CREATED true
          azd env set INDEX_DOCUMENT_COUNT $DOC_COUNT
          
          echo "Data loading complete! Indexed $DOC_COUNT documents."
        fi
    windows:
      shell: pwsh
      run: |
        Write-Host "Checking if vector store data needs to be loaded..."
        
        $indexCreated = (azd env get-values | Select-String "INDEX_CREATED").ToString().Split('=')[1]
        
        if ($indexCreated -eq "true") {
          Write-Host "Index already created. Skipping data load."
          $docCount = (azd env get-values | Select-String "INDEX_DOCUMENT_COUNT").ToString().Split('=')[1]
          Write-Host "Current document count: $docCount"
        } else {
          Write-Host "Loading vector store data..."
          npm install
          npm run build
          npm run load_data
          
          $searchService = (azd env get-values | Select-String "AZURE_AISEARCH_ENDPOINT").ToString().Split('/')[2].Split('.')[0]
          $docCount = az search index show --service-name $searchService --name northwind --query "documentCount" -o tsv 2>$null
          if (-not $docCount) { $docCount = "0" }
          
          azd env set INDEX_CREATED true
          azd env set INDEX_DOCUMENT_COUNT $docCount
          
          Write-Host "Data loading complete! Indexed $docCount documents."
        }
  
services:
  api:
    project: ./packages-v1/server-api
    language: ts
    host: containerapp
    resourceName: ${SERVICE_API_NAME}
    docker:
      path: ../../Dockerfile
      context: ../../