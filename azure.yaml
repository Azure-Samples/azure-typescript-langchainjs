name: azure-typescript-langchainjs
metadata:
  template: azure-typescript-langchainjs

infra:
  bicep:
    path: ./infra/main.bicep
    parameters:
      principalId: ${AZURE_PRINCIPAL_ID}

hooks:
  postprovision:
    posix: 
      sh: bash
      run: |
        # Get environment values for the application
        azd env get-values > .env
        echo "Environment configured. Data will be loaded after deployment."
    windows:
      shell: pwsh
      run: |
        azd env get-values > .env
        Write-Host "Environment configured. Data will be loaded after deployment."
  
  postdeploy:
    posix:
      sh: bash
      run: |
        echo "Checking if vector store data needs to be loaded..."
        
        # Check if already loaded
        INDEX_CREATED=$(azd env get-values | grep INDEX_CREATED | cut -d'=' -f2 || echo "false")
        
        if [ "$INDEX_CREATED" = "true" ]; then
          echo "Index already created. Skipping data load."
          echo "Current document count: $(azd env get-values | grep INDEX_DOCUMENT_COUNT | cut -d'=' -f2)"
        else
          echo "Loading vector store data..."
          npm install
          npm run build
          npm run load_data
          
          # Get document count from the index
          SEARCH_SERVICE=$(azd env get-values | grep AZURE_AISEARCH_ENDPOINT | cut -d'/' -f3 | cut -d'.' -f1)
          DOC_COUNT=$(az search index show --service-name $SEARCH_SERVICE --name northwind --query "documentCount" -o tsv 2>/dev/null || echo "0")
          
          # Mark as loaded
          azd env set INDEX_CREATED true
          azd env set INDEX_DOCUMENT_COUNT $DOC_COUNT
          
          echo "Data loading complete! Indexed $DOC_COUNT documents."
        fi
    windows:
      shell: pwsh
      run: |
        Write-Host "Checking if vector store data needs to be loaded..."
        
        $indexCreated = (azd env get-values | Select-String "INDEX_CREATED").ToString().Split('=')[1]
        
        if ($indexCreated -eq "true") {
          Write-Host "Index already created. Skipping data load."
          $docCount = (azd env get-values | Select-String "INDEX_DOCUMENT_COUNT").ToString().Split('=')[1]
          Write-Host "Current document count: $docCount"
        } else {
          Write-Host "Loading vector store data..."
          npm install
          npm run build
          npm run load_data
          
          $searchService = (azd env get-values | Select-String "AZURE_AISEARCH_ENDPOINT").ToString().Split('/')[2].Split('.')[0]
          $docCount = az search index show --service-name $searchService --name northwind --query "documentCount" -o tsv 2>$null
          if (-not $docCount) { $docCount = "0" }
          
          azd env set INDEX_CREATED true
          azd env set INDEX_DOCUMENT_COUNT $docCount
          
          Write-Host "Data loading complete! Indexed $docCount documents."
        }
  
services:
  api:
    project: ./packages-v1/server-api
    language: ts
    host: containerapp
    resourceName: ${SERVICE_API_NAME}
    docker:
      path: ../../Dockerfile
      context: ../../